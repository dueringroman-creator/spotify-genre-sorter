<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Playlist Alchemist</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="favicon.png">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Broman FAB - The Berghain Bouncer (Merged with Action Button) -->
  <div id="broman-fab" class="broman-fab">
    <!-- Collapsed Button (Always Visible) -->
    <button class="broman-fab-button" onclick="toggleBromanFab()" id="broman-fab-btn">
      <div class="fab-bouncer">üéß</div>
      <div class="fab-score-badge" id="fab-score-badge">0</div>
      <div class="fab-selection" id="fab-selection">
        <span id="fab-genre-count">0</span> genres
      </div>
    </button>
    
    <!-- Expanded Panel (Slides Out) -->
    <div class="broman-panel hidden" id="broman-panel">
      <div class="broman-panel-header">
        <div class="broman-panel-title">
          <span class="bouncer-icon">üéß</span>
          <span>BROMAN</span>
          <span class="bouncer-subtitle">Your Playlist Bouncer</span>
        </div>
        <button class="broman-panel-close" onclick="toggleBromanFab()">‚úï</button>
      </div>
      
      <div class="broman-panel-content">
        <!-- Commentary -->
        <div class="broman-comment-box" id="broman-comment">
          <p>"You just discovered Spotify?"</p>
        </div>
        
        <!-- Credibility Score -->
        <div class="broman-section">
          <div class="broman-section-title">CREDIBILITY SCORE</div>
          <div class="broman-score">
            <div class="score-number" id="broman-score">0</div>
            <div class="score-label" id="broman-label">Spotify Shuffle User</div>
          </div>
          <div class="score-progress">
            <div class="score-bar" id="broman-progress" style="width: 0%"></div>
          </div>
        </div>
        
        <!-- Current Selection -->
        <div class="broman-section">
          <div class="broman-section-title">CURRENT SELECTION</div>
          <div class="selection-stats">
            <div class="stat-row">
              <span class="stat-label">Genres:</span>
              <span class="stat-value" id="broman-genres">0</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Tracks:</span>
              <span class="stat-value" id="broman-tracks">0</span>
            </div>
            <div class="stat-row">
              <span class="stat-label">Duration:</span>
              <span class="stat-value" id="broman-duration">0m</span>
            </div>
          </div>
        </div>
        
        <!-- Action Buttons -->
        <div class="broman-actions">
          <button class="broman-btn broman-btn-secondary" onclick="scrollToPreview()">
            View Preview
          </button>
          <button class="broman-btn broman-btn-primary" onclick="scrollToBuilder()">
            Build Playlist ‚Üí
          </button>
        </div>
        
        <!-- Library Insights -->
        <div class="broman-section">
          <div class="broman-section-title">LIBRARY INSIGHTS</div>
          <div class="broman-insights" id="broman-insights">
            <div class="insight-loading">Analyzing your library...</div>
          </div>
        </div>
        
        <!-- Playlist History -->
        <div class="broman-section">
          <div class="broman-section-title">RECENT PLAYLISTS</div>
          <div class="broman-history" id="broman-history">
            <div class="history-empty">No playlists yet.<br>Get to work.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Search Panel (Ctrl/Cmd+K) -->
  <div id="quick-search-panel" class="quick-search-panel hidden">
    <div class="quick-search-overlay" onclick="closeQuickSearch()"></div>
    <div class="quick-search-content">
      <div class="quick-search-header">
        <div class="search-icon">üîç</div>
        <input 
          type="text" 
          id="quick-search-input" 
          placeholder="Search your library..." 
          autocomplete="off"
        />
        <button class="search-close" onclick="closeQuickSearch()">√ó</button>
      </div>
      
      <div class="quick-search-filters">
        <button class="filter-chip active" data-filter="all">All</button>
        <button class="filter-chip" data-filter="tracks">Tracks</button>
        <button class="filter-chip" data-filter="artists">Artists</button>
        <button class="filter-chip" data-filter="genres">Genres</button>
      </div>
      
      <div class="quick-search-results" id="quick-search-results">
        <div class="search-placeholder">
          <div class="placeholder-icon">üéµ</div>
          <div class="placeholder-text">Start typing to search your library</div>
          <div class="placeholder-hint">Press <kbd>Esc</kbd> to close</div>
        </div>
      </div>
      
      <div class="quick-search-footer">
        <div class="search-hints">
          <span class="hint-item"><kbd>‚Üë</kbd><kbd>‚Üì</kbd> Navigate</span>
          <span class="hint-item"><kbd>Enter</kbd> Select</span>
          <span class="hint-item"><kbd>Esc</kbd> Close</span>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <h1>Playlist Alchemist</h1>
    <button id="help-button" class="help-button" title="Show help tour">?</button>
    
    <!-- Login Section -->
    <div id="login-section" class="landing-page">
      <!-- Hero with Graphic -->
      <div class="landing-hero">
        <div class="hero-graphic">
          <svg class="chaos-to-order" viewBox="0 0 400 120" xmlns="http://www.w3.org/2000/svg">
            <!-- Chaos (scattered dots) -->
            <g class="chaos-side">
              <circle cx="20" cy="30" r="4" fill="#1db954" opacity="0.6"/>
              <circle cx="35" cy="55" r="3" fill="#1db954" opacity="0.5"/>
              <circle cx="25" cy="75" r="3.5" fill="#1db954" opacity="0.7"/>
              <circle cx="50" cy="40" r="4" fill="#1db954" opacity="0.4"/>
              <circle cx="45" cy="70" r="3" fill="#1db954" opacity="0.6"/>
              <circle cx="60" cy="50" r="3.5" fill="#1db954" opacity="0.5"/>
              <circle cx="40" cy="20" r="3" fill="#1db954" opacity="0.7"/>
              <circle cx="55" cy="85" r="4" fill="#1db954" opacity="0.5"/>
              <circle cx="30" cy="95" r="3" fill="#1db954" opacity="0.6"/>
            </g>
            
            <!-- Arrow -->
            <g class="arrow">
              <line x1="80" y1="60" x2="140" y2="60" stroke="#535353" stroke-width="2"/>
              <polygon points="140,60 135,55 135,65" fill="#535353"/>
              <text x="110" y="50" fill="#7f7f7f" font-size="10" text-anchor="middle">ALGORITHM</text>
            </g>
            
            <!-- Order (organized stacks) -->
            <g class="order-side">
              <rect x="160" y="25" width="30" height="8" rx="2" fill="#1db954" opacity="0.8"/>
              <rect x="160" y="38" width="30" height="8" rx="2" fill="#1db954" opacity="0.8"/>
              <rect x="160" y="51" width="30" height="8" rx="2" fill="#1db954" opacity="0.8"/>
              
              <rect x="200" y="35" width="30" height="8" rx="2" fill="#1db954" opacity="0.6"/>
              <rect x="200" y="48" width="30" height="8" rx="2" fill="#1db954" opacity="0.6"/>
              <rect x="200" y="61" width="30" height="8" rx="2" fill="#1db954" opacity="0.6"/>
              
              <rect x="240" y="40" width="30" height="8" rx="2" fill="#1db954" opacity="0.7"/>
              <rect x="240" y="53" width="30" height="8" rx="2" fill="#1db954" opacity="0.7"/>
              <rect x="240" y="66" width="30" height="8" rx="2" fill="#1db954" opacity="0.7"/>
            </g>
          </svg>
        </div>
        
        <h1 class="hero-title">Playlist Alchemist</h1>
        <p class="hero-tagline">
          Turn your chaotic Spotify library<br>
          into organized playlists<br>
          <span class="tagline-accent">(without the effort)</span>
        </p>
        
        <button id="login" class="btn-hero">Connect Spotify</button>
        
        <p class="landing-note">
          No servers ‚Ä¢ No tracking ‚Ä¢ Works offline
        </p>
      </div>
      
      <!-- How It Works (3 Steps with Graphics) -->
      <div class="landing-steps">
        <h2 class="steps-title">How It Works</h2>
        
        <div class="step-grid">
          <!-- Step 1 -->
          <div class="step-item">
            <div class="step-number">1</div>
            <div class="step-graphic">
              <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <circle cx="50" cy="50" r="40" fill="none" stroke="#1db954" stroke-width="2" stroke-dasharray="5,5"/>
                <circle cx="35" cy="40" r="3" fill="#1db954"/>
                <circle cx="55" cy="35" r="3" fill="#1db954"/>
                <circle cx="45" cy="55" r="3" fill="#1db954"/>
                <circle cx="60" cy="50" r="3" fill="#1db954"/>
                <circle cx="40" cy="65" r="3" fill="#1db954"/>
                <text x="50" y="92" fill="#7f7f7f" font-size="10" text-anchor="middle">YOUR LIBRARY</text>
              </svg>
            </div>
            <div class="step-title">We Analyze</div>
            <div class="step-desc">Connect Spotify and we'll organize your entire library by genre</div>
          </div>
          
          <!-- Step 2 -->
          <div class="step-item">
            <div class="step-number">2</div>
            <div class="step-graphic">
              <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <rect x="20" y="30" width="25" height="15" rx="3" fill="#1db954" opacity="0.8"/>
                <rect x="55" y="30" width="25" height="15" rx="3" fill="none" stroke="#535353" stroke-width="1.5"/>
                <rect x="20" y="55" width="25" height="15" rx="3" fill="#1db954" opacity="0.8"/>
                <rect x="55" y="55" width="25" height="15" rx="3" fill="#1db954" opacity="0.8"/>
                <text x="50" y="92" fill="#7f7f7f" font-size="10" text-anchor="middle">PICK GENRES</text>
              </svg>
            </div>
            <div class="step-title">You Choose</div>
            <div class="step-desc">Select genres, set vibe filters (BPM, energy, mood)</div>
          </div>
          
          <!-- Step 3 -->
          <div class="step-item">
            <div class="step-number">3</div>
            <div class="step-graphic">
              <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                <rect x="25" y="20" width="50" height="8" rx="2" fill="#1db954"/>
                <rect x="25" y="32" width="50" height="8" rx="2" fill="#1db954" opacity="0.8"/>
                <rect x="25" y="44" width="50" height="8" rx="2" fill="#1db954" opacity="0.6"/>
                <rect x="25" y="56" width="50" height="8" rx="2" fill="#1db954" opacity="0.8"/>
                <rect x="25" y="68" width="50" height="8" rx="2" fill="#1db954" opacity="0.7"/>
                <polygon points="50,85 45,80 55,80" fill="#1db954"/>
                <text x="50" y="95" fill="#7f7f7f" font-size="8" text-anchor="middle">TO SPOTIFY</text>
              </svg>
            </div>
            <div class="step-title">We Create</div>
            <div class="step-desc">DJ-quality playlists with smart mixing and artist diversity</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main App (hidden until logged in) -->
    <div id="app-section" class="section hidden">
      
      <!-- Sticky Control Bar -->
      <div class="sticky-control-bar hidden" id="sticky-control-bar">
        <div class="sticky-bar-content">
          <div class="selection-summary">
            <span class="selected-count" id="sticky-selected-count">0</span> genres ‚Ä¢
            <span class="track-count" id="sticky-track-count">0 tracks</span>
          </div>
          <div class="sticky-actions">
            <button class="btn-secondary btn-small" onclick="scrollToPreview()">
              View Preview
            </button>
            <button class="btn-primary btn-small" onclick="scrollToBuilder()">
              Go to Builder ‚Üí
            </button>
          </div>
        </div>
      </div>
      
      <!-- Welcome Tour Overlay -->
      <div id="tour-overlay" class="tour-overlay hidden">
        <div class="tour-step" id="tour-step-1">
          <div class="tour-content">
            <h3>Welcome to Playlist Alchemist</h3>
            <p>Ever saved <strong>thousands of songs</strong> on Spotify but felt too lazy to actually organize them into playlists?</p>
            <p><strong>Same.</strong> This tool does the heavy lifting for you.</p>
            <div class="tour-actions">
              <button class="btn-small" onclick="closeTour()">Skip Tour</button>
              <button class="btn-primary" onclick="nextTourStep(2)">Let's Go! ‚Üí</button>
            </div>
          </div>
        </div>
        
        <div class="tour-step hidden" id="tour-step-2">
          <div class="tour-content">
            <h3>How It Works</h3>
            <p><strong>Step 1:</strong> Choose where to pull your music from:</p>
            <ul>
              <li><strong>Liked Songs</strong> - Perfect for large collections (cached for speed!)</li>
              <li><strong>Top Artists</strong> - Your most-listened artists</li>
              <li><strong>Playlists</strong> - Scan all your existing playlists</li>
            </ul>
            <p><strong>Step 2:</strong> We fetch artist genres from Spotify and intelligently map 200+ micro-genres into organized families.</p>
            <p><strong>Step 3:</strong> You select genres, we create professional-quality playlists.</p>
            <div class="tour-actions">
              <button class="btn-small" onclick="prevTourStep(1)">‚Üê Back</button>
              <button class="btn-primary" onclick="nextTourStep(3)">Next ‚Üí</button>
            </div>
          </div>
        </div>
        
        <div class="tour-step hidden" id="tour-step-3">
          <div class="tour-content">
            <h3>Two Ways to View Genres</h3>
            <p>Spotify has 200+ messy micro-genres like "deep deep house" and "bubblegrunge." We clean them up:</p>
            <ul>
              <li><strong>Grouped</strong> - Organized by family (House, Techno, UK Bass, etc.). Click a family to select all sub-genres, or expand to cherry-pick.</li>
              <li><strong>Flat List</strong> - Every genre individually. For when you want complete control.</li>
            </ul>
            <p><strong>Pro tip:</strong> Start with Grouped. It's cleaner.</p>
            <div class="tour-actions">
              <button class="btn-small" onclick="prevTourStep(2)">‚Üê Back</button>
              <button class="btn-primary" onclick="nextTourStep(4)">Next ‚Üí</button>
            </div>
          </div>
        </div>
        
        <div class="tour-step hidden" id="tour-step-4">
          <div class="tour-content">
            <h3>Smart Playlist Creation</h3>
            <p>This is where things get interesting. After selecting genres, you get:</p>
            <ul>
              <li><strong>Live Preview</strong> - See track count, duration, and artist stats before creating</li>
              <li><strong>Duration Control</strong> - Set your target length (30min to 5 hours)</li>
              <li><strong>Artist Diversity</strong> - Max 3 tracks per artist by default. No more "50 tracks, 3 artists" playlists.</li>
              <li><strong>Smart Shuffle</strong> - Never puts the same artist back-to-back. Sounds like a DJ mixed it.</li>
            </ul>
            <p>Translation: You get professional playlists, not random track dumps.</p>
            <div class="tour-actions">
              <button class="btn-small" onclick="prevTourStep(3)">‚Üê Back</button>
              <button class="btn-primary" onclick="nextTourStep(5)">Next ‚Üí</button>
            </div>
          </div>
        </div>
        
        <div class="tour-step hidden" id="tour-step-5">
          <div class="tour-content">
            <h3>The Power User Stuff</h3>
            <p><strong>3-Level Control:</strong> Don't like a specific artist in a genre? Click "Show Artists" and uncheck them. Want to exclude one bad track? Click "Show Tracks."</p>
            <p><strong>Manual Mapping:</strong> See unmapped genres in "Other"? Click the orange "Map" button to categorize them yourself. Your mappings are saved forever.</p>
            <p><strong>Timeframe Filters:</strong> Only want tracks you liked in the past 3 months? There's a filter for that.</p>
            <p><strong>Sticky Controls:</strong> When you select genres, controls appear at the top. No more scrolling.</p>
            <div class="tour-actions">
              <button class="btn-small" onclick="prevTourStep(4)">‚Üê Back</button>
              <button class="btn-primary" onclick="nextTourStep(6)">Next ‚Üí</button>
            </div>
          </div>
        </div>
        
        <div class="tour-step hidden" id="tour-step-6">
          <div class="tour-content">
            <h3>Other Cool Stuff</h3>
            <p><strong>Artist Discovery:</strong> Search any artist, find similar ones from YOUR library, create discovery playlists.</p>
            <p><strong>Music Stats:</strong> See your top genres, diversity score, fun insights.</p>
            <p><strong>Export Options:</strong> Download playlists as CSV/TXT for DJ software or backup.</p>
            <p><strong>Playlist History:</strong> Everything you've created is tracked with one-click access.</p>
            <div class="tour-actions">
              <button class="btn-small" onclick="prevTourStep(5)">‚Üê Back</button>
              <button class="btn-primary" onclick="nextTourStep(7)">Next ‚Üí</button>
            </div>
          </div>
        </div>
        
        <div class="tour-step hidden" id="tour-step-7">
          <div class="tour-content">
            <h3>Your Privacy Matters</h3>
            <p><strong>No servers. No data storage. No tracking.</strong></p>
            <p>Everything runs in your browser. We cache data locally for speed, but it never leaves your device.</p>
            <p><strong>What we cache:</strong> Your library, genre mappings, manual categorizations.</p>
            <p><strong>What we don't collect:</strong> Literally anything. No personal info, no listening habits, no analytics.</p>
            <p style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #282828; font-size: 13px; color: #7f7f7f;">
              Open source ‚Ä¢ No ads ‚Ä¢ No backend ‚Ä¢ Privacy-first by design
            </p>
            <div class="tour-actions">
              <button class="btn-small" onclick="prevTourStep(6)">‚Üê Back</button>
              <button class="btn-primary" onclick="closeTour()">Start Creating</button>
            </div>
          </div>
        </div>
      </div>
      
      <div class="footer-learn-more">
        <button class="learn-more-toggle" onclick="toggleLearnMore()">
          <span id="learn-more-icon">‚ñº</span> How does the algorithm work?
        </button>
        <div id="learn-more-content" class="learn-more-content hidden">
          <p><strong>3-pass genre detection:</strong> Manual mappings ‚Üí Exact matches ‚Üí Fuzzy matching (200+ aliases) ‚Üí Word-based splitting ‚Üí Fallback to "Other"</p>
          <p><strong>Smart mixing:</strong> Artist diversity control (max N tracks per artist), smart shuffle (no consecutive same artist), duration targeting with average track length calculation</p>
          <p><strong>Audio filters:</strong> BPM, energy (intensity), and mood (valence) from Spotify's audio analysis API, cached locally</p>
          <p><strong>Privacy:</strong> Everything runs in your browser. Zero servers. LocalStorage caching for speed. No data collected.</p>
        </div>
      </div>
      
      <!-- Tab Navigation -->
      <div class="tabs">
        <button class="tab-btn active" data-tab="library">My Library</button>
        <button class="tab-btn" data-tab="artist">Artist Discovery</button>
        <button class="tab-btn" data-tab="stats">Music Stats</button>
        <button class="tab-btn" data-tab="history">Playlist History</button>
      </div>

      <!-- Tab Content: My Library -->
      <div id="library-tab" class="tab-content active">
        <h2>Create Playlist from Your Music Library</h2>
        
        <!-- Data Source Selection -->
        <div class="data-source-options">
          <h4 style="color: #e3e3e3; margin-bottom: 12px;">
            What music should we dig into?
            <span class="tooltip">i
              <span class="tooltiptext">Pick where to pull your tracks from. Liked Songs is cached for speed!</span>
            </span>
          </h4>
          <label>
            <input type="radio" name="data-source" value="liked-songs" checked>
            <span>Songs I've liked</span>
          </label>
          <div class="option-description">Your entire liked songs collection - perfect for big libraries!</div>
          
          <!-- Timeframe Filter for Liked Songs -->
          <div class="timeframe-selector" id="liked-timeframe-selector">
            <label class="timeframe-label">Timeframe:</label>
            <select id="liked-timeframe" class="timeframe-select">
              <option value="all">All time</option>
              <option value="year">Past year</option>
              <option value="6months">Past 6 months</option>
              <option value="3months">Past 3 months</option>
              <option value="month">Past month</option>
              <option value="week">Past week</option>
            </select>
          </div>
          
          <label>
            <input type="radio" name="data-source" value="top-artists">
            <span>Artists I listen to most</span>
          </label>
          <div class="option-description">Your top 50 most-played artists - quick and personalized</div>
          
          <label>
            <input type="radio" name="data-source" value="playlists">
            <span>All my playlists</span>
          </label>
          <div class="option-description">Scan everything - your created playlists, saved ones, and followed ones</div>
        </div>
        
        <div class="library-controls">
          <button id="fetch-tracks" class="btn-secondary">Let's Go</button>
          <button id="refresh-cache" class="btn-small" style="display: none;">Refresh Cache</button>
          <div id="cache-info" class="cache-info" style="display: none;"></div>
        </div>

        <!-- Genre Selection Area -->
        <div id="genre-selection-area" class="hidden">
          <div class="genre-header">
            <h3>Select Genres for Your Playlist</h3>
            
            <!-- Discrete Info Section -->
            <div class="info-section" id="genre-info-section">
              <div class="info-section-header" onclick="toggleInfoSection('genre-info-section')">
                <div class="info-section-title">
                  <span class="info-section-icon">‚ÑπÔ∏è</span>
                  <span>How genre detection works</span>
                </div>
                <span class="info-section-toggle">‚ñº</span>
              </div>
              <div class="info-section-content">
                <div class="info-section-body">
                  <p><strong>Grouped View:</strong> Genres organized into families (Electronic, Rock, Hip-Hop, etc.). Each family has a color that flows to all subgenres.</p>
                  <p><strong>Flat View:</strong> All genres listed individually. Great for precise control.</p>
                  <p><strong>Color System:</strong> Notice the colored dots and left borders? They connect subgenres to their parent family.</p>
                  <p><strong>Expanding Families:</strong> Click the expand button to see all subgenres. The family becomes the focal point with more space.</p>
                  <p><strong>Detection:</strong> We analyze artist genres from Spotify using 3-pass fuzzy matching: exact matches ‚Üí aliases (200+) ‚Üí word splitting ‚Üí fallback to "Other".</p>
                </div>
              </div>
            </div>
            
            <div class="genre-actions">
              <div class="view-toggle">
                <button class="view-btn active" data-view="grouped">Grouped</button>
                <button class="view-btn" data-view="flat">Flat List</button>
              </div>
              <input type="text" id="genre-filter" placeholder="Filter genres..." />
              <label class="filter-checkbox hidden" id="unmapped-filter-wrapper">
                <input type="checkbox" id="unmapped-filter">
                <span>Unmapped only (<span id="unmapped-count">0</span>)</span>
              </label>
              <button id="select-all-genres" class="btn-small">Select All</button>
              <button id="clear-genres" class="btn-small">Clear All</button>
            </div>
          </div>
          
          <div id="genre-stats" class="genre-stats"></div>
          
          <div class="genre-tip-card">
            <span class="genre-tip-icon">Tip:</span>
            <span class="genre-tip-text">
              Want to learn about genre history and relationships? Check out 
              <a href="https://musicmap.info/" target="_blank" class="genre-tip-link">MusicMap.info</a>
            </span>
          </div>
          
          <div id="genre-grid" class="genre-grid"></div>
          
          <!-- Sticky Playlist Controls Bar -->
          <div id="sticky-playlist-bar" class="sticky-playlist-bar hidden">
            <div class="sticky-bar-content">
              <div class="sticky-bar-info">
                <div class="sticky-bar-title">
                  <span class="sticky-icon">üéµ</span>
                  <span id="sticky-genre-count">0 genres selected</span>
                </div>
                <div class="sticky-bar-stats" id="sticky-bar-stats">
                  <span class="stat-item">0 tracks</span>
                  <span class="stat-separator">‚Ä¢</span>
                  <span class="stat-item">0m</span>
                </div>
              </div>
              <div class="sticky-bar-actions">
                <button class="btn-secondary btn-small" onclick="document.getElementById('playlist-builder').scrollIntoView({ behavior: 'smooth' })">
                  Settings
                </button>
                <button class="btn-primary btn-small" onclick="document.getElementById('playlist-builder').scrollIntoView({ behavior: 'smooth' })">
                  Create Playlist
                </button>
              </div>
            </div>
          </div>
          
          <!-- Playlist Builder Interface -->
          <div class="playlist-builder" id="playlist-builder">
            <div class="playlist-builder-header">
              <h3>Smart Playlist Builder</h3>
              <button class="toggle-advanced" onclick="toggleAdvancedSettings()">
                Advanced Settings
              </button>
            </div>
            
            <!-- Basic Settings -->
            <div class="builder-section">
              <label class="builder-label">Playlist Name</label>
              <input type="text" id="playlist-name" placeholder="Leave blank for auto-generated name..." class="builder-input" />
            </div>
            
            <!-- Playlist Templates -->
            <div class="builder-section template-section">
              <label class="builder-label">
                Quick Start Template
                <span class="info-tooltip">
                  <span class="info-icon">i</span>
                  <span class="tooltip-content">
                    <strong>Templates</strong> are pre-configured settings bundles for common use cases. Select one to auto-fill duration, diversity, and energy settings. Switch to <strong>Custom</strong> to fine-tune.
                  </span>
                </span>
              </label>
              <select id="template-selector" class="template-selector">
                <option value="custom">Custom (adjust settings below)</option>
                <option value="workout">Workout Mix - High energy, 1 hour</option>
                <option value="focus">Deep Focus - Low energy, 2 hours</option>
                <option value="party">Party Playlist - Upbeat, 3 hours</option>
                <option value="discovery">Discovery Mode - Max variety, 1 hour</option>
                <option value="commute">Commute Mix - Balanced, 45 minutes</option>
                <option value="background">Background Music - Chill, 4 hours</option>
              </select>
            </div>
            
            <!-- Duration Control -->
            <div class="builder-section">
              <label class="builder-label">
                Target Duration: <span id="duration-display">2h 0m</span>
              </label>
              <div class="duration-presets">
                <button class="preset-btn" onclick="setDuration(3600)">1 hour</button>
                <button class="preset-btn active" onclick="setDuration(7200)">2 hours</button>
                <button class="preset-btn" onclick="setDuration(10800)">3 hours</button>
                <button class="preset-btn" onclick="setDuration(14400)">4 hours</button>
              </div>
              <input type="range" id="duration-slider" min="1800" max="18000" step="300" value="7200" class="duration-slider" />
              <div class="range-labels">
                <span>30m</span>
                <span>5h</span>
              </div>
            </div>
            
            <!-- Advanced Settings (collapsible) -->
            <div class="advanced-settings hidden" id="advanced-settings">
              <div class="builder-section">
                <label class="builder-label">
                  Artist Diversity: <span id="diversity-display">Max 3 tracks per artist</span>
                  <span class="info-tooltip">
                    <span class="info-icon">i</span>
                    <span class="tooltip-content">
                      <strong>Artist Diversity</strong> prevents "artist dumps" in your playlists. Set to <code>1</code> for maximum variety (discovery mode) or <code>10</code> to allow deep dives into favorite artists.
                    </span>
                  </span>
                </label>
                <input type="range" id="diversity-slider" min="1" max="10" value="3" class="diversity-slider" />
                <div class="range-labels">
                  <span>Max variety</span>
                  <span>Allow repeats</span>
                </div>
              </div>
              
              <div class="builder-section">
                <label class="builder-checkbox">
                  <input type="checkbox" id="avoid-consecutive" checked />
                  <span>Avoid same artist back-to-back</span>
                </label>
              </div>
              
              <!-- BPM Filter -->
              <div class="builder-section">
                <label class="builder-checkbox">
                  <input type="checkbox" id="bpm-filter-enabled" />
                  <span>Filter by BPM (Tempo)</span>
                  <span class="info-tooltip">
                    <span class="info-icon">i</span>
                    <span class="tooltip-content">
                      <strong>BPM (Beats Per Minute)</strong> data comes from Spotify's Audio Features API. First use takes 2-5 seconds to fetch, then cached locally. Perfect for workout playlists or energy-specific vibes.
                    </span>
                  </span>
                </label>
                <div id="bpm-filter-controls" class="filter-controls hidden">
                  <label class="builder-label">
                    BPM Range: <span id="bpm-display">60 - 180</span>
                  </label>
                  <div class="dual-range-container">
                    <input type="range" id="bpm-min-slider" min="60" max="200" value="60" class="range-slider" />
                    <input type="range" id="bpm-max-slider" min="60" max="200" value="180" class="range-slider" />
                  </div>
                  <div class="range-labels">
                    <span>60 BPM</span>
                    <span>200 BPM</span>
                  </div>
                </div>
              </div>
              
              <!-- Energy Filter -->
              <div class="builder-section">
                <label class="builder-checkbox">
                  <input type="checkbox" id="energy-filter-enabled" />
                  <span>Filter by Energy Level</span>
                </label>
                <div id="energy-filter-controls" class="filter-controls hidden">
                  <label class="builder-label">
                    Energy: <span id="energy-display">Low ‚Üí High</span>
                  </label>
                  <div class="dual-range-container">
                    <input type="range" id="energy-min-slider" min="0" max="100" value="0" class="range-slider" />
                    <input type="range" id="energy-max-slider" min="0" max="100" value="100" class="range-slider" />
                  </div>
                  <div class="range-labels">
                    <span>üò¥ Calm</span>
                    <span>‚ö° Intense</span>
                  </div>
                </div>
              </div>
              
              <!-- Mood Filter -->
              <div class="builder-section">
                <label class="builder-checkbox">
                  <input type="checkbox" id="mood-filter-enabled" />
                  <span>Filter by Mood (Valence)</span>
                  <span class="info-tooltip">
                    <span class="info-icon">i</span>
                    <span class="tooltip-content">
                      <strong>Valence</strong> measures musical positivity from Spotify's audio analysis. High = happy/cheerful/euphoric tracks. Low = sad/melancholic/dark vibes. Great for matching playlist mood to your current state.
                    </span>
                  </span>
                </label>
                <div id="mood-filter-controls" class="filter-controls hidden">
                  <label class="builder-label">
                    Mood: <span id="mood-display">All moods</span>
                  </label>
                  <div class="dual-range-container">
                    <input type="range" id="mood-min-slider" min="0" max="100" value="0" class="range-slider" />
                    <input type="range" id="mood-max-slider" min="0" max="100" value="100" class="range-slider" />
                  </div>
                  <div class="range-labels">
                    <span>üòî Sad</span>
                    <span>üòä Happy</span>
                  </div>
                </div>
              </div>
              
              <!-- Vocal/Instrumental Filter -->
              <div class="builder-section">
                <label class="builder-checkbox">
                  <input type="checkbox" id="vocal-filter-enabled" />
                  <span>Filter by Vocals</span>
                  <span class="info-tooltip">
                    <span class="info-icon">i</span>
                    <span class="tooltip-content">
                      <strong>Vocal Detection</strong> uses Spotify's <code>speechiness</code> and <code>instrumentalness</code> data. Filter for purely instrumental tracks, vocal-heavy songs, or spoken word/rap content.
                    </span>
                  </span>
                </label>
                <div id="vocal-filter-controls" class="filter-controls hidden">
                  <label class="builder-label">
                    Vocal Type: <span id="vocal-display">Any</span>
                  </label>
                  <select id="vocal-preference" class="builder-select">
                    <option value="any">Any (No filter)</option>
                    <option value="instrumental">Instrumental Only (No vocals)</option>
                    <option value="vocal">Vocal Tracks (With singing)</option>
                    <option value="spoken">Spoken Word / Rap Heavy</option>
                  </select>
                </div>
              </div>
            </div>
            
            <!-- Preview Section -->
            <div class="builder-section preview-section" id="preview-section">
              <div class="preview-header">
                <h4>Preview</h4>
                <button class="btn-small" onclick="refreshPreview()">‚Üª Refresh</button>
              </div>
              <div class="preview-stats" id="preview-stats">
                <div class="stat-pill">
                  <span class="stat-label">Tracks</span>
                  <span class="stat-value" id="preview-tracks">‚Äî</span>
                </div>
                <div class="stat-pill">
                  <span class="stat-label">Duration</span>
                  <span class="stat-value" id="preview-duration">‚Äî</span>
                </div>
                <div class="stat-pill">
                  <span class="stat-label">Artists</span>
                  <span class="stat-value" id="preview-artists">‚Äî</span>
                </div>
                <div class="stat-pill">
                  <span class="stat-label">Avg/Artist</span>
                  <span class="stat-value" id="preview-avg">‚Äî</span>
                </div>
              </div>
              <div class="preview-tracks-list hidden" id="preview-tracks-list">
                <!-- Will be populated dynamically -->
              </div>
              <button class="btn-small" onclick="togglePreviewList()">
                <span id="preview-toggle-text">Show Track List ‚ñº</span>
              </button>
            </div>
            
            <!-- Mode Selection -->
            <div class="builder-section">
              <label class="builder-label">Organization Mode</label>
              <div class="mode-selection">
                <label class="mode-option">
                  <input type="radio" name="playlist-mode" value="merged" checked />
                  <div class="mode-card">
                    <div class="mode-title">Merged Playlist</div>
                    <div class="mode-desc">One smart playlist with all genres mixed</div>
                  </div>
                </label>
                <label class="mode-option">
                  <input type="radio" name="playlist-mode" value="separate" />
                  <div class="mode-card">
                    <div class="mode-title">Separate Playlists</div>
                    <div class="mode-desc">Individual playlist per genre (no smart mixing)</div>
                  </div>
                </label>
              </div>
            </div>
            
            <!-- Create Button -->
            <div class="builder-actions">
              <button id="create-library-playlist" class="btn-primary btn-large" disabled>
                Create Smart Playlist
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Tab Content: Artist Discovery -->
      <div id="artist-tab" class="tab-content">
        <h2>Discover Music from Any Artist</h2>
        <p style="color: #b3b3b3; font-size: 14px; margin: -10px 0 20px 0;">
          Search for any artist, then find similar artists <strong>from your own library</strong> based on matching genres. Perfect for building playlists around a specific sound!
        </p>
        
        <!-- Artist Search -->
        <div class="search-container">
          <input 
            type="text" 
            id="artist-search" 
            placeholder="Search for an artist (e.g., Tame Impala, Arctic Monkeys)..."
            autocomplete="off"
          />
          <div id="search-results" class="search-results"></div>
        </div>

        <!-- Selected Artist Display -->
        <div id="selected-artist" class="selected-artist hidden">
          <h3>Selected Artist</h3>
          <div id="artist-card" class="artist-card"></div>
          <button id="find-related" class="btn-secondary">Find Similar Artists (from your library)</button>
        </div>

        <!-- Related Artists Grid -->
        <div id="related-artists-section" class="hidden">
          <h3>Similar Artists from Your Library <span class="hint">(ranked by matching genres - click to select)</span></h3>
          
          <!-- Discovery Explanation -->
          <div class="info-section" id="discovery-info-section">
            <div class="info-section-header" onclick="toggleInfoSection('discovery-info-section')">
              <div class="info-section-title">
                <span class="info-section-icon">‚ÑπÔ∏è</span>
                <span>How artist discovery works</span>
              </div>
              <span class="info-section-toggle">‚ñº</span>
            </div>
            <div class="info-section-content">
              <div class="info-section-body">
                <p><strong>Discovery is a chain:</strong> You have Artist A ‚Üí We find similar Artist B ‚Üí Click B to find artists similar to B (C, D, E).</p>
                <p><strong>Why this matters:</strong> This helps you discover "chains" of related artists. Start with one you know, then explore artists similar to those discoveries.</p>
                <p><strong>Ranking:</strong> Artists are ranked by how many genres they share with the one you clicked. More shared genres = more similar sound.</p>
                <p><strong>Example:</strong> Arctic Monkeys ‚Üí The Strokes ‚Üí The Killers ‚Üí Franz Ferdinand. Each step finds new artists in your library with similar styles.</p>
              </div>
            </div>
          </div>
          
          <div id="related-artists-grid" class="artists-grid"></div>
          
          <div class="playlist-controls">
            <input type="text" id="discovery-playlist-name" placeholder="Playlist name (optional)" />
            <button id="generate-discovery-playlist" class="btn-primary">Generate Playlist</button>
          </div>
        </div>
      </div>

      <!-- Tab Content: Music Stats -->
      <div id="stats-tab" class="tab-content">
        <div class="stats-container">
          <h2>Your Music Profile</h2>
          <div id="stats-content" class="stats-placeholder">
            <p>Load your music library first to see your personalized stats.</p>
            <p style="color: #7f7f7f; font-size: 14px; margin-top: 10px;">Go to "My Library" tab and click "Let's Go!" to analyze your music taste.</p>
          </div>
        </div>
      </div>

      <!-- Tab Content: Playlist History -->
      <div id="history-tab" class="tab-content">
        <div class="playlist-history">
          <h3>Your Created Playlists</h3>
          <div id="history-list" class="history-list">
            <div class="history-empty">No playlists created yet. Start creating!</div>
          </div>
        </div>
      </div>

      <!-- Status Messages -->
      <div id="status" class="status-box">Ready to start!</div>
    </div>
  </div>

  <script src="app.js"></script>
</body>
</html>
